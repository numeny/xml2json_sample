<html>
    <script src="xml2json_bin.js"></script>
    <script src="queue.js"></script>

    <input type="file"
    id="avatar" name="ofd文件"
    accept="doc" onchange="onchangeFile(this.files[0])">
    <script>
        let fileId = 'f.xml';
        const gMainSliceDataQueue = new Queue();
        let gMainIsSliceDataEnded = false;

        const worker = new Worker("./file_manager.js");
        let gSliceDataMapArray = new Map();

        function getNextSliceDataImpl(param) {
            let sliceDataInfo = getSliceDataInfo(param);
            while (!sliceDataInfo.sliceDataQueue.isEmpty()) {
                let fileContent = sliceDataInfo.sliceDataQueue.dequeue();
                // console.log("main getNextSliceData: fileContent: ", fileContent);
            }

            if (!sliceDataInfo.sliceDataQueue.isEmpty() || !sliceDataInfo.isSliceDataEnded) {
                setTimeout(function() {
                    getNextSliceDataImpl(param);
                }, 50);
            }
        }

        function getNextSliceData(param) {
            let sliceDataInfo = getSliceDataInfo(param);
            if (!sliceDataInfo.sliceDataQueue.isEmpty() || !sliceDataInfo.isSliceDataEnded) {
                setTimeout(function() {
                    getNextSliceDataImpl(param);
                }, 50);
            }
        }
        
        function onWriteFileComplete(response) {
            var param = {
                    fileId: fileId,
                    relativePath: fileId,
                    fileFullPath: fileId,
                    willSlice: false,
                    sliceType: 0,
                    sliceRowNum: 200,
                    willSaveTransformResult: true,
                };
            if (param.sliceType == 0) {
                worker.postMessage({
                    command: "getDocumentSectPrArray",
                    param: param,
                });
            } else if (param.sliceType == 1) {
                worker.postMessage({
                    command: "getExcelSheetHeadAndTail",
                    param: param,
                });
            }

            for(var a = 0; a < 1; a++) {
                setTimeout(function() {
                    worker.postMessage({
                        command: "getTransformFile",
                        param: param,
                    });
                }, a*20);
            }
        }

        function onGetTransformFileComplete(response) {
            let fileContent = response?.result?.fileContent;
            console.log("main onGetTransformFileComplete: fileContent: ", fileContent);
        }

        function getSliceDataInfo(param) {
            let relativePath = param?.relativePath;
            if (!relativePath) {
                console.error("Err: getSliceDataInfo: no relativePath in param: ", param);
                return null;
            }
            let gSliceDataMap;
            if (!gSliceDataMapArray.has(param?.fileId)) {
                gSliceDataMap = new Map();
                gSliceDataMapArray[param?.fileId] = gSliceDataMap;
            } else {
                gSliceDataMap = gSliceDataMapArray[param?.fileId];
            }
            let sliceDataInfo;
            if (!gSliceDataMap.has(relativePath)) {
                sliceDataInfo = {
                    sliceDataQueue: new Queue(),
                    isSliceDataEnded: false,
                };
                gSliceDataMap[relativePath] = sliceDataInfo;
            }

            return sliceDataInfo;
        }
        function onParsedSliceDataComplete(response) {
            console.log("main onParsedSliceDataComplete: response: ", response);
            let result = response?.result;
            if (!result) {
                console.error("Err: main onParsedSliceDataComplete: no response: ", response)
                return;
            }
            let fileContent = result?.fileContent;
            if (fileContent?.length > 0) {
                // fileContent = new TextDecoder().decode(fileContent);
                try {
                    fileContent = JSON.parse(fileContent);
                    console.log("main onParsedSliceDataComplete: fileContent: ", fileContent);
                } catch (err) {
                    console.error("Err: main onParsedSliceDataComplete: ", fileContent, response?.param, err)
                }
            }
            console.log("main onParsedSliceDataComplete: fileContent: ", fileContent);
            let sliceDataInfo = getSliceDataInfo(response?.param);
            sliceDataInfo.sliceDataQueue.enqueue(fileContent);
            sliceDataInfo.isSliceDataEnded = result.isEnded;
            
            getNextSliceData(response?.param);
        }

        function onGetExcelSheetHeadAndTail(response) {
            var fileContent = response?.result?.fileContent;
            console.log("main onGetExcelSheetHeadAndTailComplete: fileContent: ", fileContent);
        }
        function onGetDocumentSectPrArrayComplete(response) {
            var fileContent = response?.result?.fileContent;
            console.log("main onGetDocumentSectPrArrayComplete: fileContent: ", fileContent);
        }

        function onEndDocumentComplete(response) {
            let sliceDataInfo = getSliceDataInfo(response?.param);
            sliceDataInfo.isSliceDataEnded = true;
            console.warn("onEndDocumentComplete: ", response);
        }
        function inspectResponse() {
            worker.addEventListener("message", (message) => {
                var handlers = {
                    // "onOpenFileComplete": onOpenFileComplete,
                    "onWriteFileComplete": onWriteFileComplete,
                    "onGetTransformFileComplete": onGetTransformFileComplete,
                    "onParsedSliceDataComplete": onParsedSliceDataComplete,
                    "onGetExcelSheetHeadAndTail": onGetExcelSheetHeadAndTail,
                    "onGetDocumentSectPrArrayComplete": onGetDocumentSectPrArrayComplete,
                    "onEndDocumentComplete": onEndDocumentComplete,
                    // "onWorkerReady": onWorkerReady,
                };
                var response = message.data;
                // if (response instanceof ArrayBuffer) {
                //     let fileContent = response;
                //     console.log("main onGetNextSliceComplete-1: ArrayBuffer: ", fileContent);
                //     // if (fileContent?.byteLength > 0) {
                //         console.log("main onGetNextSliceComplete-2: ArrayBuffer: ", fileContent);
                //         fileContent = new TextDecoder().decode(fileContent);
                //         console.log("main onGetNextSliceComplete-3: ArrayBuffer: ", fileContent);
                //         try {
                //             fileContent = JSON.parse(fileContent)
                //             console.log("main onGetNextSliceComplete-4: ArrayBuffer: ", fileContent);
                //         } catch (err) {
                //             console.error("Err: main onGetNextSliceComplete: ", fileContent, err)
                //         }
                //     // }
                // }
                console.log("--- [Debug] main received: response:", response)
                var func = handlers[response.command]
                if (func == undefined) {
                    // console.log("[Info] main no handler for command: " + response.command);
                    return;
                }
                return func(response);
            });
        };
        inspectResponse();
        window.counter = 0;
        function onchangeFile(file) {
            window.counter++;
            var a = window.counter.toString();
            var reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = async function () {
                // var fileContent = reader.result;
                // fileContent = new TextDecoder().decode(fileContent);
                // FS.writeFile(fileId, fileContent);
                // var fileContent = FS.readFile(fileId, { encoding: 'utf8' });
                // console.log(fileContent);

                // FS.writeFile(fileId, 'foobar');
                // // FS.truncate(fileId, 3);
                // console.log(FS.readFile(fileId, { encoding: 'utf8' }));

                worker.postMessage({
                    command: "writeFile",
                    param: reader.result,
                });
            }
        }

        console.log("11111111");
    </script>


</html>

